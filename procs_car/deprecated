DROP TABLE IF EXISTS temporario.gridbr;
CREATE TABLE temporario.gridbr as
SELECT ROW_NUMBER() OVER () id,*
FROM  ST_CreateFishnet(4100, 4000, 0.1, 0.1, -74.3904499689998971, -34.7511779939999457) AS cells;

CREATE INDEX gridbr_idx_geom ON temporario.gridbr USING GIST (geom);



CREATE TABLE temporario.gridbr_filtrado AS 
SELECT id, ROW, col, a.geom FROM temporario.gridbr a 
LEFT JOIN geo_adm.pa_br_limitenacional_250_2015_ibge_4674 b ON ST_Intersects(a.geom, b.geom)
WHERE b.gid IS NOT NULL 


CREATE INDEX gridbr_filtrado_idx_geom ON temporario.gridbr_filtrado USING GIST (geom);











DROP TABLE IF EXISTS car.car_dump;
CREATE TABLE car.car_dump AS 
SELECT gid, (st_dump(a.geom)).geom geom FROM dados_brutos.sicar_imoveis_al a
RIGHT JOIN temporario.gridbr_filtrado b ON ST_Intersects(a.geom, b.geom) WHERE 
b.id IN (992381, 992382, 992383)  





SELECT st_asbinary((ST_Dump(ST_Split(ST_Union(g) , ST_Union(g2)))).geom) bin,  --pega o binário de cada feição para group by posterior
(ST_Dump(ST_Split(ST_Union(g), ST_Union(g2)))).geom geom --feições
FROM car.car_dump, 
LATERAL ( --lateral join que retorna as feições clusterizadas. O gid se perde porém será resgatado no proc2 
SELECT  unnest(ST_ClusterIntersecting(geom)) g , --retorna geometria
ST_ExteriorRing((ST_Dump(unnest(ST_ClusterIntersecting(geom)))).geom) g2 -- retorna lines para split   
FROM car.car_dump) bar; 



SELECT count(*) FROM temporario.gridbr_filtrado gf 









SELECT id, ST_Intersection(g2, a.geom) geom FROM temporario.gridbr_filtrado a, LATERAL (
SELECT (ST_Dump(unnest(ST_ClusterIntersecting(geom)))).geom g2 
FROM car.car_dump) b
WHERE a.id IN (992381, 992382, 992383) AND NOT ST_Isempty(ST_Intersection(g2, a.geom))  ;


DROP TABLE IF EXISTS car.proc1_clustering ; 
CREATE TABLE car.proc1_clustering AS 















SELECT (ST_Dump(unnest(ST_ClusterIntersecting(geom)))).geom g2 
FROM car.car_dump








CREATE TABLE car.proc2_split AS 
SELECT bin, ST_Union(a.geom), array_agg(b.gid), ST_Area(ST_Union(a.geom)::geography) area  FROM car.proc1_clustering a 
LEFT JOIN car.car_dump b ON ST_Intersects(ST_Buffer(a.geom::geography, -5), b.geom)
GROUP BY bin





